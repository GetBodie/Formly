generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Engagement {
  id                  String   @id @default(cuid())
  clientName          String
  clientEmail         String
  taxYear             Int      // Auto-set to current year on creation
  status              String   @default("PENDING") // PENDING | INTAKE_DONE | COLLECTING | READY

  // Storage provider (dropbox)
  storageProvider     String   @default("dropbox")
  storageFolderUrl    String
  storageFolderId     String?
  storageDriveId      String?
  storagePageToken    String?  // Page token for delta sync

  // Typeform
  typeformFormId      String

  // All data as JSONB
  intakeData          Json?    @db.JsonB
  checklist           Json?    @db.JsonB
  documents_jsonb     Json?    @db.JsonB @map("documents") // Legacy JSONB, drop in phase 2
  reconciliation      Json?    @db.JsonB
  prepBrief           String?  @db.Text

  // New relation
  documents           Document[]

  // Agent tracking
  lastActivityAt      DateTime?
  reminderCount       Int      @default(0)
  lastReminderAt      DateTime?
  agentLog            Json?    @db.JsonB

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Document {
  id                  String     @id @default(uuid())
  engagementId        String
  engagement          Engagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  fileName            String
  storageItemId       String
  documentType        String     @default("PENDING")
  confidence          Float      @default(0)
  taxYear             Int?
  issues              String[]   @default([])
  checks              Json?      @map("issueDetails") @db.JsonB
  override            Json?      @db.JsonB

  classifiedAt        DateTime?
  processingStatus    String     @default("pending")
  processingStartedAt DateTime?
  retryCount          Int        @default(0)

  approvedAt          DateTime?

  archivedAt          DateTime?
  archivedReason      String?

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  @@index([engagementId])
  @@index([processingStatus])
  @@index([engagementId, archivedAt])
  @@index([engagementId, storageItemId])
}
